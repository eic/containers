image: eicweb.phy.anl.gov:4567/containers/image_recipes/ubuntu_dind:latest
#
stages:
  - phase1
  - phase2
  - phase3

eic_builder_release:
  stage: phase1
  tags:
     - sodium dind
  only:
     - tags
     - master
  script:
     - cd containers/builder
     - head Dockerfile
     - make login
     - make release-cached
eic_builder_develop:
  stage: phase1
  tags:
     - sodium dind
  only:
     - develop
  script:
     - cd containers/builder
     - head Dockerfile
     - make login
     - make develop-cached

eic_release:
  stage: phase2
  tags:
     - sodium dind
  only:
     - tags
     - master
  script:
     - cd containers/release
     - make login
     - make release-cached
eic_develop:
  stage: phase2
  tags:
     - sodium dind
  only:
     - develop
  script:
     - cd containers/release
     - make login
     - make develop-cached

eic_builder_singularity:
  stage: phase2
  tags:
     - sodium dind
  only:
     - staging
     - tags
  when: manual
  script:
     - cp containers/builder/eic_builder.def .
     - /bin/bash .gitlabci/setup.sh
     - /bin/bash .gitlabci/build.sh eic_builder.def
     - mkdir -p build 
     - cp eic_builder.sif build/.
     - cp eic_builder.def build/.
  artifacts:
      paths:
        - build/eic_builder.sif
        - build/eic_builder.def

eic_singularity:
  stage: phase3
  tags:
     - sodium dind
  only:
     - staging
     - tags
  script:
     - cp containers/release/eic.def .
     - /bin/bash .gitlabci/setup.sh
     - /bin/bash .gitlabci/build.sh eic.def
     - mkdir -p build 
     - cp eic.sif build/.
     - cp eic.def build/.
  artifacts:
      paths:
        - build/eic.sif
        - build/eic.def
