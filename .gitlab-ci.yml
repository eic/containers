image: eicweb.phy.anl.gov:4567/containers/image_recipes/ubuntu_dind:latest

stages:
  - config
  - trigger

## make note if we cannot use caching for one of the stages
## by touching files in .ci_env
default:
  tags:
    - silicon
  artifacts:
    paths: 
      - .ci-env
detect_changes:builder:
  stage: .pre
  rules:
    - changes:
        - gitlab-ci/docker/*
        - containers/builder/Dockerfile
        - containers/builder/spack.yaml
        - spack/packages/**/*
  script:
    - mkdir -p .ci-env
    - touch .ci-env/builder-nc
detect_changes:release:
  stage: .pre
  rules:
    - changes:
        - gitlab-ci/docker/*
        - gitlab-ci/singularity/*
        - containers/release/Dockerfile.in
        - containers/release/configure_release.sh
  script:
    - mkdir -p .ci-env
    - touch .ci-env/release-nc

## Init our job for our desired branches/tags/events
init:
  stage: config
  script:
    - ./gitlab-ci/configure_pipeline.sh gitlab-ci/build_and_deploy.yml.in
  artifacts:
    paths:
      - build_and_deploy.yml

## Dispatch if we ran the previous stage
run:default:
  stage: trigger
  trigger:
    include: 
      - artifact: build_and_deploy.yml
        job: init
    strategy: depend
