image: eicweb.phy.anl.gov:4567/containers/image_recipes/ubuntu_dind:latest
#
stages:
  - builder
  - config
  - main
  - singularity

builder:stable:
  stage: builder
  tags:
     - silicon
  only:
     - tags
     - master
  script:
     - cd containers/builder
     - head Dockerfile
     - make login
     - make release-cached
builder:testing:
  stage: builder
  tags:
     - silicon
  only:
     - staging
  script:
     - cd containers/builder
     - head Dockerfile
     - make login
     - make staging-cached
builder:unstable:
  stage: builder
  tags:
     - silicon
  except:
     - tags
     - master
     - staging
  script:
     - cd containers/builder
     - head Dockerfile
     - make login
     - make develop

## I wish there were a simple way to transfer the "latest/unstable" strings
## between jobs...
config:stable:
  image: eicweb.phy.anl.gov:4567/containers/eic_container/eic_builder:latest
  stage: config
  tags:
    - silicon
  only:
     - tags
     - master
  needs: ["builder:stable"]
  script:
    - bash containers/release/configure_release.sh latest
  artifacts:
    paths:
      - config/spack-env.sh
      - config/eic-env.sh
      - config/Dockerfile
config:testing:
  image: eicweb.phy.anl.gov:4567/containers/eic_container/eic_builder:testing
  stage: config
  tags:
    - silicon
  only:
     - staging
  needs: ["builder:testing"]
  script:
    - bash containers/release/configure_release.sh testing
  artifacts:
    paths:
      - config/spack-env.sh
      - config/eic-env.sh
      - config/Dockerfile
config:unstable:
  image: eicweb.phy.anl.gov:4567/containers/eic_container/eic_builder:unstable
  stage: config
  tags:
    - silicon
  except:
     - tags
     - master
     - staging
  needs: ["builder:unstable"]
  script:
    - bash containers/release/configure_release.sh unstable
  artifacts:
    paths:
      - config/spack-env.sh
      - config/eic-env.sh
      - config/Dockerfile
      
release:stable:
  stage: main
  tags:
     - silicon
  only:
     - tags
     - master
  needs: ["config:stable"]
  script:
     - cp config/Dockerfile containers/release/Dockerfile
     - cp config/eic-env.sh containers/release/eic-env.sh
     - cd containers/release
     - make login
     - make release-cached
release:testing:
  stage: main
  tags:
     - silicon
  only:
     - staging
  needs: ["config:testing"]
  script:
     - cp config/Dockerfile containers/release/Dockerfile
     - cp config/eic-env.sh containers/release/eic-env.sh
     - cd containers/release
     - make login
     - make staging-cached
release:unstable:
  stage: main
  tags:
     - silicon
  except:
     - tags
     - master
     - staging
  needs: ["config:unstable"]
  script:
     - cp config/Dockerfile containers/release/Dockerfile
     - cp config/eic-env.sh containers/release/eic-env.sh
     - cd containers/release
     - make login
     - make develop-cached

builder:singularity:
  stage: singularity
  tags:
     - singularity
  only:
     - tags
  needs: ["builder:stable"]
  when: manual
  script:
     - cp containers/builder/eic_builder.def .
     - /bin/bash .gitlabci/setup.sh
     - /bin/bash .gitlabci/build.sh eic_builder.def
     - mkdir -p build 
     - cp eic_builder.sif build/.
     - cp eic_builder.def build/.
  artifacts:
      paths:
        - build/eic_builder.sif
        - build/eic_builder.def

release:singularity:
  stage: singularity
  tags:
     - singularity
  only:
     - tags
  needs: ["release:stable"]
  script:
     - cp containers/release/eic.def .
     - /bin/bash .gitlabci/setup.sh
     - /bin/bash .gitlabci/build.sh eic.def
     - mkdir -p build 
     - cp eic.sif build/.
     - cp eic.def build/.
  artifacts:
      expire_in: 90 days # this will change in future gitlab vesions :https://docs.gitlab.com/13.3/ee/ci/yaml/README.html#artifactsexpire_in
      paths:
        - build/eic.sif
        - build/eic.def
