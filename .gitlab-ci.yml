image: eicweb.phy.anl.gov:4567/containers/image_recipes/ubuntu_dind:latest

stages:
  - builder
  - config
  - slim
  - singularity

builder:stable:
  stage: builder
  tags:
    - silicon
  only:
    - tags
    - master
  script:
    - cd containers/builder
    - head Dockerfile
    - make login
    - make release-cached
builder:unstable:
  stage: builder
  tags:
    - silicon
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_SOURCE_BRANCH != "develop"'
      when: always
    - if: '$CI_COMMIT_BRANCH == "develop"'
      when: always
  script:
    - cd containers/builder
    - head Dockerfile
    - make login
    - make develop-cached

config:stable:
  image: eicweb.phy.anl.gov:4567/containers/eic_container/eic_builder:latest
  stage: config
  tags:
    - silicon
  only:
    - tags
    - master
  needs: ["builder:stable"]
  script:
   - bash containers/release/configure_release.sh latest
  artifacts:
    paths:
      - config/spack-env.sh
      - config/eic-env.sh
      - config/Dockerfile
config:unstable:
  image: eicweb.phy.anl.gov:4567/containers/eic_container/eic_builder:unstable
  stage: config
  tags:
    - silicon
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_SOURCE_BRANCH != "develop"'
      when: manual
    - if: '$CI_COMMIT_BRANCH == "develop"'
      when: always
  needs: ["builder:unstable"]
  script:
    - bash containers/release/configure_release.sh unstable
  artifacts:
    paths:
      - config/spack-env.sh
      - config/eic-env.sh
      - config/Dockerfile
      
release:stable:
  stage: slim
  tags:
     - silicon
  only:
     - tags
     - master
  needs: ["config:stable"]
  script:
     - cp config/Dockerfile containers/release/Dockerfile
     - cp config/eic-env.sh containers/release/eic-env.sh
     - cd containers/release
     - make login
     - make release-cached
release:unstable:
  stage: slim
  tags:
     - silicon
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_SOURCE_BRANCH != "develop"'
      when: manual
    - if: '$CI_COMMIT_BRANCH == "develop"'
      when: always
  needs: ["config:unstable"]
  script:
     - cp config/Dockerfile containers/release/Dockerfile
     - cp config/eic-env.sh containers/release/eic-env.sh
     - cd containers/release
     - make login
     - make develop-cached

release:singularity:
  stage: singularity
  tags:
     - silicon
  rules:
    - if: '$CI_COMMIT_TAG'
      when: always
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: manual
  needs: ["release:stable"]
  script:
     - cp containers/release/eic.def .
     - /bin/bash .gitlabci/setup.sh
     - /bin/bash .gitlabci/build.sh eic.def
     - mkdir -p build 
     - cp eic.sif build/.
     - cp eic.def build/.
  artifacts:
      expire_in: 90 days
      paths:
        - build/eic.sif
        - build/eic.def
release:singularity:unstable:
  stage: singularity
  tags:
     - silicon
  needs: ["release:unstable"]
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_SOURCE_BRANCH != "develop"'
      when: manual
    - if: '$CI_COMMIT_BRANCH == "develop"'
      when: manual
  script:
     - cp containers/release/eic.def .
     - /bin/bash .gitlabci/setup.sh
     - /bin/bash .gitlabci/build.sh eic.def
     - mkdir -p build 
     - cp eic.sif build/.
     - cp eic.def build/.
  artifacts:
      expire_in: 90 days 
      paths:
        - build/eic.sif
        - build/eic.def
