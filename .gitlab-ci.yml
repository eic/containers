image: eicweb.phy.anl.gov:4567/containers/image_recipes/ubuntu_dind:latest

stages:
  - config
  - build
  - deploy

## make note if we cannot use caching for one of the stages
## by touching files in .ci_env
default:
  tags:
    - silicon
  artifacts:
    paths: 
      - .ci-env
detect_changes:builder:
  stage: .pre
  rules:
    - changes:
        - containers/builder/spack.yaml
        - spack/packages/**/*
  script:
    - mkdir -p .ci-env
    - touch .ci-env/builder-nc
detect_changes:release:
  stage: .pre
  rules:
    - changes:
        - containers/release/configure_release.sh
  script:
    - mkdir -p .ci-env
    - touch .ci-env/release-nc

## Init our job for our desired branches/tags/events
init:
  stage: config
  script:
    - ./gitlab-ci/configure.sh containers/build_and_deploy.yml.in
  artifacts:
    paths:
      - build_and_deploy.yml

## Dispatch if we ran the previous stage
run:default:
  stage: build
  trigger:
    include: 
      - artifact: build_and_deploy.yml
        job: init
    strategy: depend

singularity:
  stage: deploy
  needs: ["run:default"]
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: on_success
    - if: '$CI_COMMIT_BRANCH =~ /v[0-9]+\.[0-9]+-stable/'
      when: on_success
    - if: '$CI_COMMIT_TAG =~ /v[0-9]+\.[0-9]+\.[0-9]+/'
      when: on_success
  script:
     - mkdir -p build 
     - cd build
     - ../gitlab-ci/configure.sh ../containers/release/eic.def.in
     - /bin/bash ../gitlab-ci/singularity/build.sh eic.def
  artifacts:
      expire_in: 90 days
      paths:
        - build/eic.sif
        - build/eic.def
