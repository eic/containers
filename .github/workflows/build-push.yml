name: build-push

on:
  schedule:
    - cron: "30 */6 * * *"
  push:
    branches:
    - master  
  pull_request:
    branches:
    - master
  workflow_dispatch:
    inputs:
      EDM4EIC_VERSION:
        required: false
        default: ''
        type: string
      EICRECON_VERSION:
        required: false
        default: ''
        type: string
      JUGGLER_VERSION:
        required: false
        default: ''
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  packages: write

env:
  ## Default versions are specified in packages.yaml but can be overridden
  ## note: nightly builds will always use the master/main branch
  EDM4EIC_VERSION: ${{ inputs.EDM4EIC_VERSION }}
  EICRECON_VERSION: ${{ inputs.EICRECON_VERSION }}
  JUGGLER_VERSION: ${{ inputs.JUGGLER_VERSION }}

  ## Dockerhub registry
  DH_REGISTRY: docker.io
  DH_REGISTRY_USER: eicweb
  DH_PUSH: 0
  ## GitHub registry
  GH_REGISTRY: ghcr.io
  GH_REGISTRY_USER: eic
  GH_PUSH: 1

  ## Number of jobs to start during container builds
  JOBS: 4

  ## Internal tag used for the CI
  INTERNAL_TAG: pipeline-${{ github.run_id }}

jobs:
  base:
    name: Build base on ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
        - BASE_IMAGE: debian:stable-slim
          BUILD_IMAGE: debian_stable_base
          PLATFORM: linux/amd64 
          runner: ubuntu-latest
          arch: amd64
        - BASE_IMAGE: debian:stable-slim
          BUILD_IMAGE: debian_stable_base
          PLATFORM: linux/arm64
          runner: ubuntu-24.04-arm
          arch: arm64
    steps:
      - name: Checkout 
        uses: actions/checkout@v4
      - name: Load spack version and cherry-picks
        id: spack
        shell: bash
        run: |
          source spack.sh
          echo "orgrepo=${SPACK_ORGREPO}" | tee -a $GITHUB_OUTPUT
          echo "version=${SPACK_VERSION}" | tee -a $GITHUB_OUTPUT
          echo "cherrypicks=${SPACK_CHERRYPICKS//$'\n'/ }" | tee -a $GITHUB_OUTPUT
          echo "cherrypicks_files=${SPACK_CHERRYPICKS_FILES//$'\n'/ }" | tee -a $GITHUB_OUTPUT
      - name: Load spack-packages version aversionry-picks
        id: spack-packages
        shell: bash
        run: |
          source spack-packages.sh
          echo "orgrepo=${SPACKPACKAGES_ORGREPO}" | tee -a $GITHUB_OUTPUT
          echo "version=${SPACKPACKAGES_VERSION}" | tee -a $GITHUB_OUTPUT
          echo "cherrypicks=${SPACKPACKAGES_CHERRYPICKS//$'\n'/ }" | tee -a $GITHUB_OUTPUT
          echo "cherrypicks_files=${SPACKPACKAGES_CHERRYPICKS_FILES//$'\n'/ }" | tee -a $GITHUB_OUTPUT
      - name: Load key4hep-spack version
        id: key4hep-spack
        run: |
          source key4hep-spack.sh
          echo "orgrepo=${KEY4HEPSPACK_ORGREPO}" | tee -a $GITHUB_OUTPUT
          echo "version=${KEY4HEPSPACK_VERSION}" | tee -a $GITHUB_OUTPUT
      - name: Load eic-spack version
        id: eic-spack
        run: |
          source eic-spack.sh
          echo "orgrepo=${EICSPACK_ORGREPO}" | tee -a $GITHUB_OUTPUT
          echo "version=${EICSPACK_VERSION}" | tee -a $GITHUB_OUTPUT
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            name=${{ env.DH_REGISTRY }}/${{ env.DH_REGISTRY_USER }}/${{ matrix.BUILD_IMAGE }},enable=${{ env.DH_PUSH != 0 }}
            name=${{ env.GH_REGISTRY }}/${{ env.GH_REGISTRY_USER }}/${{ matrix.BUILD_IMAGE }},enable=${{ env.GH_PUSH != 0 }}
          tags: |
            type=sha,prefix=${{ matrix.arch }}-
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        if: ${{ env.DH_PUSH == '1' }}
        with:
          registry: ${{ env.DH_REGISTRY }}
          username: ${{ env.DH_REGISTRY_USER }}
          password: ${{ secrets.DH_EICWEB_TOKEN }}
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        if: ${{ env.GH_PUSH == '1' }}
        with:
          registry: ${{ env.GH_REGISTRY }}
          username: ${{ secrets.GHCR_REGISTRY_USER }}
          password: ${{ secrets.GHCR_REGISTRY_TOKEN }}
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          file: containers/debian/Dockerfile
          context: containers/debian
          platforms: ${{ matrix.PLATFORM }}
          labels: ${{ steps.meta.outputs.labels }}
          outputs: type=image,name=${{ steps.meta.outputs.tags }},push-by-digest=true,name-canonical=true
          build-args: |
            BASE_IMAGE=${{ matrix.BASE_IMAGE }}
            BUILD_IMAGE=${{ matrix.BUILD_IMAGE }}
            SPACK_ORGREPO=${{ steps.spack.outputs.orgrepo }}
            SPACK_VERSION=${{ steps.spack.outputs.version }}
            SPACK_CHERRYPICKS=${{ steps.spack.outputs.cherrypicks }}
            SPACK_CHERRYPICKS_FILES=${{ steps.spack.outputs.cherrypicks_files }}
            SPACKPACKAGES_ORGREPO=${{ steps.spack-packages.outputs.orgrepo }}
            SPACKPACKAGES_VERSION=${{ steps.spack-packages.outputs.version }}
            SPACKPACKAGES_CHERRYPICKS=${{ steps.spack-packages.outputs.cherrypicks }}
            SPACKPACKAGES_CHERRYPICKS_FILES=${{ steps.spack-packages.outputs.cherrypicks_files }}
            KEY4HEPSPACK_ORGREPO=${{ steps.key4hep-spack.outputs.orgrepo }}
            KEY4HEPSPACK_VERSION=${{ steps.key4hep-spack.outputs.version }}
            EICSPACK_ORGREPO=${{ steps.eic-spack.outputs.orgrepo }}
            EICSPACK_VERSION=${{ steps.eic-spack.outputs.version }}
            jobs=${{ env.JOBS }}
          cache-from: type=gha,scope=${{ matrix.arch }}-${{ github.workflow }}
          cache-to: type=gha,mode=max,scope=${{ matrix.arch }}-${{ github.workflow }}
      - name: Export digest to file
        # The build-push action outputs the digest at steps.build.outputs.digest
        # We write this to a file for the next job
        run: |
          mkdir -p /tmp/digests
          echo "${{ steps.build.outputs.digest }}" > /tmp/digests/${{ matrix.arch }}.digest
      - name: Upload digest as artifact
        uses: actions/upload-artifact@v4
        with:
          name: base-${{ matrix.arch }}-digest
          path: /tmp/digests/${{ matrix.arch }}.digest
          retention-days: 1

  base-manifest:
    name: Push base manifest
    runs-on: ubuntu-latest
    needs: base
    steps:
      - name: Set up QEMU (for imagetools)
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        if: ${{ env.DH_PUSH == '1' }}
        with:
          registry: ${{ env.DH_REGISTRY }}
          username: ${{ env.DH_REGISTRY_USER }}
          password: ${{ secrets.DH_EICWEB_TOKEN }}
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        if: ${{ env.GH_PUSH == '1' }}
        with:
          registry: ${{ env.GH_REGISTRY }}
          username: ${{ secrets.GHCR_REGISTRY_USER }}
          password: ${{ secrets.GHCR_REGISTRY_TOKEN }}
      - name: Download all digest artifacts
        uses: actions/download-artifact@v4
        with:
          path: /tmp/digests
          pattern: base-*-digest
          merge-multiple: true
      - name: Extract Docker metadata for final tags
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ env.IMAGE_NAME }}
          tags: |
            ${{ env.INTERNAL_TAG }}
            type=ref,prefix=unstable-pr-,event=pr
            type=match,pattern=^v(\d+\.\d+\.\d+-.*)$,group=1
      - run: ls -alR /tmp/digests
      - run: cat /tmp/digests/amd64.digest
      - name: Create and push manifest list
        run: |
          # Read the digests from the files
          DIGEST_AMD64=$(cat /tmp/digests/amd64.digest)
          DIGEST_ARM64=$(cat /tmp/digests/arm64.digest)
          # Get the base image name from the digests (they'll be the same)
          # e.g., ghcr.io/my-org/my-repo@sha256:...
          BASE_IMAGE_NAME=$(echo $DIGEST_AMD64 | cut -d'@' -f1)
          echo "Base image: $BASE_IMAGE_NAME"
          echo "AMD64 Digest: $DIGEST_AMD64"
          echo "ARM64 Digest: $DIGEST_ARM64"
          # Create the manifest list and tag it with the final tags
          docker buildx imagetools create \
            --tag ${{ steps.meta.outputs.tags }} \
            $DIGEST_AMD64 \
            $DIGEST_ARM64

  eic:
    name: Build eic on ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    needs: base-manifest
    strategy:
      matrix:
        include:
        - BUILD_IMAGE: eic_
          ENV: xl
          BUILD_TYPE: default
          BUILDER_IMAGE: debian_stable_base
          RUNTIME_IMAGE: debian_stable_base
          PLATFORM: linux/amd64
          runner: ubuntu-latest
          arch: amd64
        - BUILD_IMAGE: eic_
          ENV: xl
          BUILD_TYPE: default
          BUILDER_IMAGE: debian_stable_base
          RUNTIME_IMAGE: debian_stable_base
          PLATFORM: linux/arm64
          runner: ubuntu-24.04-arm
          arch: arm64
    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          android: true
          dotnet: true
      - name: Checkout
        uses: actions/checkout@v4
      - name: Load secrets into mirrors.yaml
        id: mirrors
        run: |
          source spack.sh
          export SPACKPACKAGES_VERSION
          export CI_REGISTRY=ghcr.io
          export CI_PROJECT_PATH=eic
          cat mirrors.yaml.in | envsubst > mirrors.yaml
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            name=${{ env.DH_REGISTRY }}/${{ env.DH_REGISTRY_USER }}/${{ matrix.BUILD_IMAGE }}${{ matrix.ENV }},enable=${{ env.DH_PUSH != 0 }}
            name=${{ env.GH_REGISTRY }}/${{ env.GH_REGISTRY_USER }}/${{ matrix.BUILD_IMAGE }}${{ matrix.ENV }},enable=${{ env.GH_PUSH != 0 }}
          tags: |
            type=sha,prefix=${{ matrix.arch }}-
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        if: ${{ env.DH_PUSH == '1' }}
        with:
          registry: ${{ env.DH_REGISTRY }}
          username: ${{ env.DH_REGISTRY_USER }}
          password: ${{ secrets.DH_EICWEB_TOKEN }}
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        if: ${{ env.GH_PUSH == '1' }}
        with:
          registry: ${{ env.GH_REGISTRY }}
          username: ${{ secrets.GHCR_REGISTRY_USER }}
          password: ${{ secrets.GHCR_REGISTRY_TOKEN }}
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          file: containers/eic/Dockerfile
          context: containers/eic
          build-contexts: |
            spack-environment=spack-environment
          secrets: |
            "CI_REGISTRY_USER=${{ secrets.GHCR_REGISTRY_USER }}"
            "CI_REGISTRY_PASSWORD=${{ secrets.GHCR_REGISTRY_TOKEN }}"
            "GITHUB_REGISTRY_USER=${{ secrets.GHCR_REGISTRY_USER }}"
            "GITHUB_REGISTRY_TOKEN=${{ secrets.GHCR_REGISTRY_TOKEN }}"
          secret-files: |
            mirrors=mirrors.yaml
          platforms: ${{ matrix.PLATFORM }}
          labels: ${{ steps.meta.outputs.labels }}
          outputs: type=image,name=${{ steps.meta.outputs.tags }},push-by-digest=true,name-canonical=true
          build-args: |
            DOCKER_REGISTRY=${{ env.GH_REGISTRY }}/${{ env.GH_REGISTRY_USER }}/
            BUILDER_IMAGE=${{ matrix.BUILDER_IMAGE }}
            RUNTIME_IMAGE=${{ matrix.RUNTIME_IMAGE }}
            INTERNAL_TAG=${{ env.INTERNAL_TAG }}
            ENV=${{ matrix.ENV }}
          cache-from: type=gha,scope=${{ matrix.arch }}-${{ github.workflow }}
          cache-to: type=gha,mode=max,scope=${{ matrix.arch }}-${{ github.workflow }}
      - name: Export digest to file
        # The build-push action outputs the digest at steps.build.outputs.digest
        # We write this to a file for the next job
        run: |
          mkdir -p /tmp/digests
          echo "${{ steps.build.outputs.digest }}" > /tmp/digests/${{ matrix.arch }}.digest
      - name: Upload digest as artifact
        uses: actions/upload-artifact@v4
        with:
          name: eic-${{ matrix.arch }}-digest
          path: /tmp/digests/${{ matrix.arch }}.digest
          retention-days: 1
