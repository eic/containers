name: Cleanup Buildcache

on:
  pull_request:
    types: [closed]
    branches:
    - master

permissions:
  packages: write

jobs:
  cleanup-buildcache:
    name: Cleanup buildcache for PR ${{ github.event.pull_request.number }}
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup buildcache tags from ghcr.io
        env:
          GH_TOKEN: ${{ secrets.GHCR_REGISTRY_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # Delete buildcache tags for this PR from ghcr.io
          # The buildcache image is at ghcr.io/eic/buildcache
          # Tags follow the pattern: {BUILD_IMAGE}-{PR_NUMBER}-{arch}
          
          echo "Cleaning up buildcache tags for PR #${PR_NUMBER}"
          
          # List all versions of the buildcache package
          echo "Fetching buildcache package versions..."
          VERSIONS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/orgs/eic/packages/container/buildcache/versions?per_page=100" \
            --paginate \
            --jq '.[] | select(.metadata.container.tags[]? | contains("-'"${PR_NUMBER}"'-")) | .id')
          
          if [ -z "$VERSIONS" ]; then
            echo "No buildcache versions found for PR #${PR_NUMBER}"
            exit 0
          fi
          
          # Delete each matching version
          echo "Found buildcache versions to delete:"
          for version_id in $VERSIONS; do
            # Get the tags for this version for logging
            TAGS=$(gh api \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/orgs/eic/packages/container/buildcache/versions/${version_id}" \
              --jq '.metadata.container.tags[]? | select(. != null)' 2>/dev/null | tr '\n' ',' | sed 's/,$//')
            
            echo "  Deleting version ${version_id} with tags: ${TAGS}"
            
            gh api \
              --method DELETE \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/orgs/eic/packages/container/buildcache/versions/${version_id}" \
              || echo "  Warning: Failed to delete version ${version_id}"
          done
          
          echo "Buildcache cleanup completed for PR #${PR_NUMBER}"
