## Ensure the container still works for the new container
## even with a strange environment setup


test:tutorial:
  stage: test
  needs:
    - version
    - jug_xl:singularity:nightly
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: on_success
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: on_success
    - when: never
  script:
    - mkdir eic && cd eic
    - mkdir -p .gitlab-ci && mv ../build/jug_xl.sif .gitlab-ci/jug_xl-ci-test.sif
    # setup our environment to be weird
    - |
      echo ROOTSYS=/invalid-path >> ~/.bashrc
      echo CC=`which gfortran` >> ~/.bashrc
      echo CXX=`which gfortran` >> ~/.bashrc
    # setup tutorial starting position
    - bash ../install.sh -v ci-test
    # now attempt the tutorial
    - ./eic-shell -- ../tests/tutorial/quick-start.sh
    - ./eic-shell -- ../tests/tutorial/part1.sh
